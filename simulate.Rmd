---
title: "Simulation study"
output:
  html_document: default
  pdf_document: default
date: "2024-06-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load utility

```{r get libraries and utilities, echo=TRUE, message=FALSE, warning=FALSE}

library(tidyverse)
library(mvtnorm)
library(sf)
library(purrr)
library(foreach)

library(mgcv)
library(rjags)
library(coda)
library(LaplacesDemon)

source("src/functions/simulate_fcts.r")
source("src/functions/jags_ini.R")

years <- 1:5

# get grid 
grid.filename <- "data/L9310x10grid.rds"
grid <- readRDS(grid.filename) %>%
  st_as_sf(crs = 2154)

grid$px <- 1:nrow(grid)
grid$logArea <- log(as.numeric(st_area(grid)) / 1000 ** 2)

# get sampling effort
effort.filename <- "data/samplingEffort.rds"
effort <- readRDS(effort.filename) 

# keep only 5 years
effort <- effort[, c(1,4,6,8,12)] 

# define detection probability
b <- 0.5

# define thining probability
rho <- 0.5
```

## 1. Simulate latent state

```{r simulate latent state, warning = FALSE}

# 1. Coordinates of the centers of the distribution areas (Brettagne, Massif Central, Facade Aquitaine)
mu <- list(
  c(0.15,0.7),
  c(0.55,0.4),
  c(0.3,0.3)) 

# 2. Shape and initial size of the distribution areas
sigma <-list(
  c(5000, 2500),
  c(5000, 1000),
  c(2500, 5000))

# 3. Yearly increase of the distribution areas
r <- 2500

# 4. Simulate using gen_mvn function as a multivariate normal density function (fct adapted from Fidino 2021)
simDat <- map(years, grid, .f = function(t, grid){
  grid$year <- t
  grid$lambda <- map(1:3, .f = function(i){
    gen_mvn(grid, mu[[i]], sigma[[i]] + c(r,r) * (t-1), 0)}) %>%
    reduce(`+`)
    
  grid
}) 

simDat <- reduce(simDat, rbind)

rm(mu, sigma, r)
```

### Plot latent space 

```{r plot simulated latent}

ggplot(simDat) + 
  geom_sf(aes(fill = 1 - exp(-lambda)), col = NA)+
  facet_wrap(~year) + 
  theme_bw()

```

## 2. Simulate observation data

```{r}

simDat$effort <- c(effort)

b <- 0.5
rho <- 0.5

simDat <- simDat %>% 
  rowwise() %>%
  mutate(psi = 1 - exp(-lambda),
         z = rbinom(1, 1, psi),
         K = rbinom(1, 1, 0.2) * (rpois(1,2) + 1),
         ypa = rbinom(1, K, z * rho),
         ypo = rpois(1, lambda * b * effort)) %>%
  filter(effort>0 | K>0)

```

```{r plot simulated data}

ggplot(simDat) + 
  geom_sf(aes(fill = ypo), col = NA)+
  facet_wrap(~year) + 
  theme_bw() +
  ggtitle("Nb of presence only obs. per px")

ggplot(simDat %>% filter(K>0)) + 
  geom_sf(aes(fill = sign(ypa)), col = NA)+
  facet_wrap(~year) + 
  theme_bw() +
  ggtitle("Summary of presence-absence surveys")

```

## 3. Format data to run the model 

```{r format data for JAGS, warning=FALSE}

# GAM stuff 
NSPLINES = 20

jags.file <- "src/JAGS/test.jags"

tmpDat <- grid %>%
  st_centroid() %>%
  st_transform(crs = 4326) %>%
  st_coordinates() %>%
  data.frame(1, .)

names(tmpDat) <- c("y", "E", "N")

gamDat <- jagam(
  y ~ s(
    E,
    N,
    k = NSPLINES,
    bs = "ds",
    m = c(1, 0.5)
  ),
  data = tmpDat,
  file = jags.file,
  family = "binomial"
)

rm(tmpDat)

gamDat$jags.ini$b[1] <- -4.6 #log area of cells

# 5. Create data list

data.list <- list(
  npxt = nrow(simDat),
  npixel = nrow(grid),
  nyear = length(unique(simDat$year)),
  px = simDat$px,
  t = simDat$year,
  ypa = simDat$ypa,
  K = simDat$K,
  ypo = simDat$ypo,
  is_po_sampled = simDat$effort,
  nprotocols = 1,
  pa_protocol = rep(1, nrow(simDat)),
  ncov_lam = 1,
  ncov_thin = 1,
  ncov_rho = 1,
  cell_area = simDat$logArea,
  x_latent =  matrix(0, nrow(grid), 1),
  x_thin = matrix(1, nrow(grid), 1),
  x_rho =  matrix(0, nrow(grid), 1),
  nspline = length(gamDat$jags.data$zero),
  x_gam = gamDat$jags.data$X,
  S1 = gamDat$jags.data$S1,
  zero = gamDat$jags.data$zero
)

inits <- foreach(i = 1:4) %do% {
  my_inits(i)
}
```

## 4. Fit Model

```{r FIT}

### Params ---------------------------------------------------------------------

jagsPar <- list(N.CHAINS = 4,
                ADAPT = 500,
                BURNIN = 1000,
                SAMPLE = 1000,
                THIN = 1)

### Call jags ------------------------------------------------------------------

## Integrated Species Distribution Model (PA + PO) ##

# mod <- jags.model(
#   file = "src/JAGS/JAGSmod_bis.R",
#   data = data.list,
#   inits = inits,
#   n.chains = jagsPar$N.CHAINS,
#   n.adapt = jagsPar$ADAPT)
# 
# update(mod, jagsPar$BURNIN)
# 
# mcmc <- coda.samples(
#   mod,
#   variable.names = c(
#     "z",
#     "b",
#     "beta_region",
#     "beta_latent",
#     "beta_rho",
#     "beta_rho_protocol",
#     "beta_thin",
#     "lambda_gam"
#   ),
#   n.iter = jagsPar$SAMPLE,
#   thin = jagsPar$THIN
# )
# 
# rm(mod, jagsPar, inits)
# 
# out <- as.matrix(as.mcmc.list(mcmc), chains = T)
# 
# outpath <- paste0("out/","Simulated", format(Sys.time(),"%Y%m%d_%H%M%S"), ".RData")
# 
# save.image(file=outpath)

load("out/Simulated20240626_203646.RData")
```

## 5. Plot output

### A. Map of lambda

```{r create lam dataframe, message=FALSE}

bbb <- out[, grep("b\\[", colnames(out))]

ll <- map(seq_along(unique(simDat$year)), function(.t){
  simDat <- filter(simDat, year == .t)
  bbb[,(1:20) + (.t-1)*20] %*% t(gamDat$jags.data$X[simDat$px,]) + matrix(rep(simDat$logArea, nrow(out)),
                                                                              nrow = nrow(out),
                                                                              ncol = nrow(simDat),
                                                                              byrow = TRUE)
})

rm(bbb)

ll <- reduce(ll, cbind)

simDat$estLam <- apply(exp(ll), 2, mean)
simDat$sdLam <- apply(exp(ll), 2, sd)

rm(ll)

simDat$estPsi <- 1 - exp(-simDat$estLam)
simDat <- simDat %>% 
  group_by(px) %>%
  arrange(year) %>%
  mutate(dpsi = estPsi - lag(estPsi, 1))
```

```{r plot latent}

ggplot() +
  geom_sf(data = grid, fill = "lightgrey", col = NA) +
  geom_sf(data = simDat, aes(fill = estPsi), col = NA) +
  scale_fill_gradient2(
    low = "white",
    mid = "orange",
    high = "darkred",
    midpoint = .5
  ) +
  facet_wrap( ~ year) +
  theme_bw()

```

### B. Posterior distribution of b and rho

```{r get posteriors}
b_est <- out[, grep("beta_thin", colnames(out))]
rho_est <- out[, grep("beta_rho_protocol", colnames(out))]

post <- data.frame(value = invlogit(c(b_est, rho_est)),
                  param = rep(c("b", "rho"), each = length(b_est)))
```

```{r plot posteriors}

ggplot(post)+
  geom_violin(aes(x = param, y = value, fill = param)) + 
  geom_hline(aes(yintercept = 0.5)) +
  theme_bw()

```

